<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Team Jersey Customizer</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for JSX compilation in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Configure Tailwind for custom colors and font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#111827',
                        'secondary-dark': '#1f2937',
                    }
                }
            }
        }
    </script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Lucide Icons (Required for component icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-900 font-sans">

    <!-- Root container for React app -->
    <div id="root"></div>

    <script type="text/babel">
        // Import necessary hooks and icons from React and Lucide-React (using global scope for CDNs)
        const { useState, useCallback, useRef, useEffect } = React;
        const {
            Image, Loader, Zap, Shirt, Palette, User,
            Upload, FileText, Dribbble, Goal, TrendingUp,
            Trophy, // Used for Baseball/Softball
            Shield, // Used for Football/Hockey/Rugby/Lacrosse
            Layers // Icon for design elements
        } = lucide;

        // --- IMPORTANT: PASTE YOUR API KEY HERE ---
        // Replace "" with your actual Google AI API Key.
        // This MUST be done manually in this file.
        const API_KEY = "AIzaSyCOsjZrGVDQcdkuLCKH6N0dWNZ5JgXCKOM"; 
        // NOTE: The previous VITE_API_KEY environment variable logic is replaced with a direct string constant here.

        // Transparent 1x1 PNG Base64 Data. Used to force the image generation model (gemini-2.5-flash-image-preview).
        const BLANK_LOGO_BASE64 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';

        // List of available sports jersey types, sorted alphabetically
        const JERSEY_TYPES = [
            { value: 'baseball', label: 'Baseball', icon: Trophy },
            { value: 'basketball', label: 'Basketball', icon: Dribbble },
            { value: 'cycling', label: 'Cycling', icon: TrendingUp },
            { value: 'field_hockey', label: 'Field Hockey', icon: Goal },
            { value: 'football', label: 'Football', icon: Shield },
            { value: 'hockey', label: 'Hockey', icon: Shield },
            { value: 'lacrosse', label: 'Lacrosse', icon: Shield },
            { value: 'rugby', label: 'Rugby', icon: Shield },
            { value: 'soccer', label: 'Soccer', icon: Goal },
            { value: 'softball', label: 'Softball', icon: Trophy },
            { value: 'track_and_field', label: 'Track & Field', icon: TrendingUp },
            { value: 'volleyball', label: 'Volleyball', icon: Dribbble },
            { value: 'wrestling', label: 'Wrestling', icon: User },
        ];

        /**
         * Converts a File object (Image) into a Base64 string for the API payload.
         * @param {File} file The image file object.
         * @returns {Promise<string>} Base64 encoded data string (without prefix).
         */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove the 'data:image/png;base64,' prefix before resolving
                    const base64Data = reader.result.split(',')[1];
                    if (!base64Data) {
                        reject(new Error("Failed to extract Base64 data from file."));
                    } else {
                        resolve(base64Data);
                    }
                };
                reader.onerror = (error) => reject(error);
            });
        };

        // Helper component for text inputs
        const InputGroup = ({ label, icon: Icon, value, onChange, placeholder, color }) => (
            <div className="flex flex-col space-y-2">
                <label className="text-sm font-medium text-gray-300 flex items-center">
                    <Icon className={`w-4 h-4 mr-2 ${color}`} />
                    {label}
                </label>
                <input
                    type="text"
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    className="p-3 border border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 bg-gray-700 text-white"
                />
            </div>
        );

        // Helper component for color pickers
        const ColorPickerGroup = ({ label, value, onChange, color }) => (
            <div className="flex flex-col space-y-2">
                <label className="text-sm font-medium text-gray-300 flex items-center">
                    <Palette className={`w-4 h-4 mr-2 ${color}`} />
                    {label}
                </label>
                <div className="flex items-center space-x-3">
                    <input
                        type="color"
                        value={value}
                        onChange={onChange}
                        className="w-12 h-12 rounded-lg cursor-pointer border-2 border-gray-700 p-0"
                        style={{ backgroundColor: value }}
                    />
                    <input
                        type="text"
                        value={value}
                        onChange={onChange}
                        className="p-3 border border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 bg-gray-700 text-white w-24 font-mono"
                    />
                </div>
            </div>
        );

        const App = () => {
            // --- State for Customization Inputs ---
            const [jerseyType, setJerseyType] = useState('basketball');
            const [teamName, setTeamName] = useState('VICTORY');
            const [primaryColor, setPrimaryColor] = useState('#EF4444'); // Red
            const [secondaryColor, setSecondaryColor] = useState('#FFFFFF'); // White
            const [thirdColor, setThirdColor] = useState('#10B981'); // Green Accent
            const [designElements, setDesignElements] = useState('');

            // State for Logo Management
            const [logoFile, setLogoFile] = useState(null);
            const [logoPreviewUrl, setLogoPreviewUrl] = useState('');
            const [logoDescription, setLogoDescription] = useState('A clean text logo or simple design placed on the center chest.');
            
            const fileInputRef = useRef(null);

            // --- State for Image Generation ---
            const [imageUrl, setImageUrl] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            
            // Check if the API key is provided and not the placeholder
            const apiKeyProvided = API_KEY && API_KEY.length > 5 && API_KEY !== 'undefined';


            // Cleanup object URL when component unmounts or logo changes
            useEffect(() => {
                return () => {
                    if (logoPreviewUrl) {
                        URL.revokeObjectURL(logoPreviewUrl);
                    }
                };
            }, [logoPreviewUrl]);

            // Handler for logo file upload
            const handleLogoUpload = (event) => {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    if (logoPreviewUrl) {
                        URL.revokeObjectURL(logoPreviewUrl);
                    }
                    setLogoFile(file);
                    const newUrl = URL.createObjectURL(file);
                    setLogoPreviewUrl(newUrl);
                    // Update prompt to focus on using the uploaded image
                    setLogoDescription(`Please use the attached logo file, named "${file.name}". Render this exact logo prominently placed on the center chest area.`);
                } else {
                    setLogoFile(null);
                    setLogoPreviewUrl('');
                    setLogoDescription('A clean text logo or simple design placed on the center chest.');
                }
            };


            // Exponential backoff retry function for API calls
            const withRetry = useCallback(async (fn, retries = 3) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        return await fn();
                    } catch (err) {
                        if (i === retries - 1) throw err;
                        const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }, []);

            // --- Dynamic Prompt Builder ---
            const constructPrompt = useCallback((hasRealLogo) => {
                const typeLabel = JERSEY_TYPES.find(t => t.value === jerseyType)?.label || 'Jersey';
                
                // Design Instruction: conditional inclusion of stripes, gradients, etc.
                const designInstruction = designElements.trim() 
                    ? `- Pattern/Design: Incorporate the following design elements: ${designElements}.` 
                    : '';

                let logoInstruction;

                if (hasRealLogo) {
                    // Case 1: Real Logo Uploaded. Tell the AI to use the image.
                    logoInstruction = `Use the attached image as the logo. Place this exact logo on the center chest.`;
                } else {
                    // Case 2: No Logo Uploaded. Tell the AI to IGNORE the blank image (forcing the multimodal path) 
                    // and instead create a text-based design.
                    logoInstruction = `**NO EXTERNAL LOGO IS PROVIDED.** Ignore the blank image input. Instead, the logo should be the team name, "${teamName.toUpperCase()}", rendered as a clean, sharp decal in the Secondary Color. Place this decal prominently on the center chest as the main graphic.`;
                }

                const detailPrompt = `
                    **CRITICAL COLOR AND TEXT ENFORCEMENT:** The jersey MUST STRICTLY use these three hex colors: Primary: ${primaryColor}, Secondary: ${secondaryColor}, Accent: ${thirdColor}. AVOID ALL other prominent colors.
                    
                    Render a highly detailed, photorealistic front and back mockup of a team ${typeLabel} jersey, 
                    hanging naturally with subtle fabric folds, made of modern synthetic fabric. 
                    
                    Key Features: 
                    - Main Fabric Color: ${primaryColor}
                    - Trim and Number Color: ${secondaryColor}
                    - Accent Color: ${thirdColor}
                    - ${logoInstruction}
                    - Numbers: Use a legible font for the numbers, rendered in the Secondary Color.
                    - Text Quality: The word "${teamName.toUpperCase()}" MUST be clean and correctly spelled. AVOID ALL GIBBERISH OR EXTRANEOUS TEXT ARTIFACTS on the jersey or background.
                    ${designInstruction}
                    
                    Style: Soft studio lighting, hyper-realistic, 8k resolution, clean white background, no watermarks.
                `;
                
                return detailPrompt;
            }, [jerseyType, teamName, primaryColor, secondaryColor, thirdColor, designElements]);

            // --- Image Generation Handler ---
            const generateImage = useCallback(async () => {
                if (!apiKeyProvided) {
                    setError("API Key is missing. Please paste your key into the code.");
                    return;
                }

                setIsLoading(true);
                setError(null);
                setImageUrl('');

                const modelName = 'gemini-2.5-flash-image-preview'; // UNIFIED MODEL
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${API_KEY}`;
                
                let base64ImageToUse;
                let mimeTypeToUse;
                let hasRealLogo = false;

                if (logoFile) {
                    // User uploaded a file: use the real image data
                    try {
                        base64ImageToUse = await fileToBase64(logoFile);
                        mimeTypeToUse = logoFile.type;
                        hasRealLogo = true;
                    } catch (e) {
                        console.error("Error reading logo file:", e);
                        setError("Could not read the uploaded logo file. Please try a different image.");
                        setIsLoading(false);
                        return;
                    }
                
                } else {
                    // No file uploaded: use the blank transparent image
                    base64ImageToUse = BLANK_LOGO_BASE64;
                    mimeTypeToUse = 'image/png';
                }
                
                const prompt = constructPrompt(hasRealLogo);

                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: mimeTypeToUse,
                                    data: base64ImageToUse
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        responseModalities: ['TEXT', 'IMAGE']
                    },
                };

                try {
                    const fetchFn = async () => {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const errorBody = await response.json();
                            throw new Error(errorBody.error?.message || `API call failed with status: ${response.status}`);
                        }
                        return response.json();
                    };

                    const result = await withRetry(fetchFn);
                    
                    // Extract image data from the multimodal response structure
                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    
                    if (base64Data) {
                        setImageUrl(`data:image/png;base64,${base64Data}`);
                    } else {
                        setError("Image generation failed to return data. The AI may be struggling with complex instructions.");
                    }
                } catch (err) {
                    console.error("Image generation error:", err);
                    setError(`Failed to generate image. Please check your API key or try simplifying the design elements. (${err.message})`);
                } finally {
                    setIsLoading(false);
                }
            }, [constructPrompt, withRetry, logoFile, apiKeyProvided]); 

            // Find the current icon based on the selected jersey type
            const currentJerseyType = JERSEY_TYPES.find(t => t.value === jerseyType);
            const IconComponent = currentJerseyType?.icon || Shirt;


            return (
                <div className="min-h-screen bg-gray-900 text-gray-200 p-4 sm:p-8 font-sans">
                    <h1 className="text-4xl font-extrabold text-center mb-12 flex items-center justify-center text-white">
                        <Image className="w-9 h-9 mr-3 text-purple-400" />
                        AI Team Jersey Customizer
                    </h1>

                    {!apiKeyProvided && (
                        <div className="bg-red-600/20 border-l-4 border-red-500 text-red-100 p-4 mb-6 rounded-lg max-w-6xl mx-auto" role="alert">
                            <p className="font-bold">CRITICAL SETUP WARNING</p>
                            <p>The **API Key is missing**. Please paste your valid Google AI key into the `const API_KEY = ""...` line in the code to enable image generation.</p>
                        </div>
                    )}

                    <div className="flex flex-col lg:flex-row gap-8 max-w-6xl mx-auto">
                        
                        {/* Left Side: Customization Controls */}
                        <div className="lg:w-1/3 bg-gray-800 p-6 rounded-2xl shadow-2xl h-fit">
                            <h2 className="text-2xl font-semibold mb-6 border-b pb-2 border-gray-700 text-white flex items-center">
                                <Palette className="w-5 h-5 mr-2 text-blue-400" />
                                Customization Controls
                            </h2>
                            
                            <div className="space-y-5">
                                
                                {/* 1. Jersey Type */}
                                <div className="flex flex-col space-y-2">
                                    <label className="text-sm font-medium text-gray-300 flex items-center">
                                        <Shirt className="w-4 h-4 mr-2 text-yellow-400" />
                                        Jersey Type
                                    </label>
                                    <select
                                        value={jerseyType}
                                        onChange={(e) => setJerseyType(e.target.value)}
                                        className="p-3 border border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 bg-gray-700 text-white appearance-none cursor-pointer"
                                    >
                                        {JERSEY_TYPES.map(type => (
                                            <option key={type.value} value={type.value}>{type.label}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                {/* 2. Team Name */}
                                <InputGroup 
                                    label="Team Name/Text (Max 15 Chars)"
                                    icon={User}
                                    value={teamName}
                                    onChange={(e) => setTeamName(e.target.value.toUpperCase().slice(0, 15))}
                                    placeholder="e.g., WARRIORS"
                                    color="text-green-400"
                                />
                                
                                {/* 3. Primary Color */}
                                <ColorPickerGroup 
                                    label="Primary Color (Body)"
                                    value={primaryColor}
                                    onChange={(e) => setPrimaryColor(e.target.value)}
                                    color="text-red-400"
                                />

                                {/* 4. Secondary Color */}
                                <ColorPickerGroup 
                                    label="Secondary Color (Trim/Numbers)"
                                    value={secondaryColor}
                                    onChange={(e) => setSecondaryColor(e.target.value)}
                                    color="text-blue-400"
                                />
                                
                                {/* 5. Third Color */}
                                <ColorPickerGroup 
                                    label="Third Color (Accent)"
                                    value={thirdColor}
                                    onChange={(e) => setThirdColor(e.target.value)}
                                    color="text-yellow-400"
                                />

                                {/* Specific Design Elements */}
                                <div className="flex flex-col space-y-2">
                                    <label className="text-sm font-medium text-gray-300 flex items-center">
                                        <Layers className="w-4 h-4 mr-2 text-cyan-400" />
                                        Design Patterns & Elements (e.g., Stripes, Gradient)
                                    </label>
                                    <textarea
                                        rows="2"
                                        value={designElements}
                                        onChange={(e) => setDesignElements(e.target.value)}
                                        className="w-full p-3 border border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 bg-gray-700 text-white resize-none"
                                        placeholder="e.g., Vertical pinstripes in secondary color, subtle geometric pattern."
                                    />
                                    <p className="text-xs text-gray-500">
                                        This text guides the AI on specific visual features of the jersey fabric or cut.
                                    </p>
                                </div>

                                {/* 6. Logo Upload & Description */}
                                <div className="flex flex-col space-y-2">
                                    <label className="text-sm font-medium text-gray-300 flex items-center">
                                        <Upload className="w-4 h-4 mr-2 text-purple-400" />
                                        Logo File Upload
                                    </label>
                                    <input
                                        type="file"
                                        accept="image/*"
                                        onChange={handleLogoUpload}
                                        ref={fileInputRef}
                                        className="block w-full text-sm text-gray-400
                                            file:mr-4 file:py-2 file:px-4
                                            file:rounded-full file:border-0
                                            file:text-sm file:font-semibold
                                            file:bg-purple-500 file:text-white
                                            hover:file:bg-purple-600 cursor-pointer
                                        "
                                    />
                                    
                                    {logoPreviewUrl && (
                                        <div className="mt-4 p-3 bg-gray-700 rounded-lg flex items-center space-x-3">
                                            <img src={logoPreviewUrl} alt="Logo Preview" className="w-10 h-10 object-contain rounded" />
                                            <span className="text-xs text-gray-300 truncate">{logoFile.name}</span>
                                            <button 
                                                onClick={() => {
                                                    setLogoFile(null);
                                                    setLogoPreviewUrl('');
                                                    setLogoDescription('A clean text logo or simple design placed on the center chest.');
                                                    fileInputRef.current.value = ''; // Reset file input
                                                }}
                                                className="text-red-400 hover:text-red-500 text-xs ml-auto"
                                            >
                                                Remove
                                            </button>
                                        </div>
                                    )}

                                    <label className="text-sm font-medium text-gray-300 flex items-center pt-4">
                                        <FileText className="w-4 h-4 mr-2 text-purple-400" />
                                        Logo Placement Description (For AI Rendering)
                                    </label>
                                    <textarea
                                        rows="2"
                                        value={logoDescription}
                                        onChange={(e) => setLogoDescription(e.target.value)}
                                        className="w-full p-3 border border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 bg-gray-700 text-white resize-none"
                                        placeholder="Describe the logo you uploaded (e.g., A fierce red dragon head)"
                                    />
                                    <p className="text-xs text-gray-500">
                                        When a logo is uploaded, the AI uses the **image file itself** along with this text description for best results. If no logo is uploaded, it generates a text design.
                                    </p>
                                </div>

                                {/* Generate Button */}
                                <button
                                    onClick={generateImage}
                                    disabled={isLoading || !apiKeyProvided}
                                    className="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-xl text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 transition duration-150 ease-in-out shadow-lg disabled:opacity-50 mt-6"
                                >
                                    {isLoading ? (
                                        <>
                                            <Loader className="animate-spin w-5 h-5 mr-3" />
                                            Rendering Mockup...
                                        </>
                                    ) : (
                                        <>
                                            <Zap className="w-5 h-5 mr-2" />
                                            Generate High-Quality Mockup
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>

                        {/* Right Side: Jersey Preview */}
                        <div className="lg:w-2/3 bg-gray-800 p-6 rounded-2xl shadow-2xl flex flex-col items-center justify-center min-h-[500px]">
                            <h2 className="text-2xl font-semibold mb-4 text-white flex items-center">
                                <IconComponent className="w-6 h-6 mr-2 text-yellow-400" />
                                {currentJerseyType?.label || 'Jersey'} Preview
                            </h2>
                            <div className="w-full h-full aspect-square bg-gray-700 flex items-center justify-center rounded-xl overflow-hidden p-8">
                                {error && (
                                    <div className="text-red-400 p-6 bg-red-900/50 rounded-lg w-full text-center">
                                        **Generation Error:** {error}
                                    </div>
                                )}
                                {isLoading && (
                                    <div className="flex flex-col items-center justify-center text-purple-400">
                                        <Loader className="animate-spin w-16 h-16 mb-4" />
                                        <p className="text-lg font-medium">AI is generating your custom jersey...</p>
                                    </div>
                                )}
                                {imageUrl && !isLoading && (
                                    <img 
                                        src={imageUrl} 
                                        alt="AI Generated Team Jersey Mockup" 
                                        className="w-full h-auto rounded-lg shadow-2xl transition-transform duration-500"
                                    />
                                )}
                                {!imageUrl && !isLoading && !error && (
                                    <div className="text-gray-500 dark:text-gray-400 text-center p-6">
                                        <Image className="w-16 h-16 mx-auto mb-3" />
                                        <p>Customize your design and click 'Generate High-Quality Mockup' to see the result here.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the main App component
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>