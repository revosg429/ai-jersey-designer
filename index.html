<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Jersey Designer - Direct API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Set Inter font globally */
        html { font-family: 'Inter', sans-serif; }

        /* Custom styles for aesthetic appeal */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .generate-button {
            transition: all 0.2s ease;
        }
        .generate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(126, 34, 206, 0.4);
        }
        /* Custom image styling */
        .mockup-image {
            max-width: 100%;
            height: auto;
            max-height: 80vh; /* Responsive height limit */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 md:p-8 flex flex-col items-center">
    <header class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">
            AI Jersey Designer (Direct API)
        </h1>
        <p class="text-gray-400 mt-2">Design custom sports mockups using a prompt. (Logo upload feature disabled for direct API call).</p>
    </header>

    <main class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Input & Controls Column (Column 1) -->
        <div class="lg:col-span-1 space-y-6">
            
            <!-- Prompt Input -->
            <div class="card p-6 rounded-xl shadow-lg">
                <label for="prompt" class="block text-lg font-semibold mb-2 text-purple-300">1. Describe Your Jersey Design</label>
                <textarea id="prompt" 
                          rows="6" 
                          placeholder="Example: A professional soccer jersey mockup, bold stripes in crimson and silver, futuristic texture, visible stitching, high quality photo, studio lighting." 
                          class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:ring-pink-500 focus:border-pink-500 text-gray-200 resize-none"></textarea>
            </div>
            
            <!-- Logo Note (Removed input field) -->
            <div class="card p-4 rounded-xl shadow-lg bg-gray-800 border-yellow-500 border">
                 <p class="text-sm text-yellow-300 font-semibold">
                    Note: Due to API limitations, the image upload feature has been removed. Please describe any logos or text in your prompt instead.
                </p>
            </div>

            <!-- Generate Button -->
            <button id="generateButton" 
                    class="generate-button w-full py-3 rounded-xl text-xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white shadow-xl flex items-center justify-center disabled:opacity-50"
                    onclick="generateMockup()">
                Generate High-Quality Mockup
            </button>
        </div>

        <!-- Output Column (Column 2 & 3) -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Message/Error Box -->
            <div id="messageBox" class="hidden p-4 rounded-xl text-sm font-medium"></div>

            <!-- Image Output Container -->
            <div class="card p-4 rounded-xl shadow-lg min-h-[400px] flex items-center justify-center relative">
                <div id="imageDisplay" class="w-full h-full flex items-center justify-center">
                    <p class="text-gray-500 text-center">Your custom jersey mockup will appear here after generation.</p>
                </div>
                
                <!-- Loading Spinner -->
                <div id="loadingOverlay" class="absolute inset-0 bg-gray-900/70 backdrop-blur-sm items-center justify-center hidden flex-col p-4 rounded-xl">
                    <svg class="animate-spin h-10 w-10 text-pink-500 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-lg font-semibold text-white">Generating Mockup...</p>
                    <p class="text-sm text-gray-300 mt-1">This uses the Imagen model and typically takes 10-30 seconds.</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // === Configuration for Direct API Call ===
        const MODEL_NAME = 'imagen-4.0-generate-001';
        const API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:predict?key=`;
        const API_KEY = ""; // Canvas provides this automatically via proxy
        
        const MAX_RETRIES = 3;
        const RETRY_DELAY_MS = 2000; // Increased delay for model stability

        // === DOM Elements ===
        const promptInput = document.getElementById('prompt');
        const generateButton = document.getElementById('generateButton');
        const imageDisplay = document.getElementById('imageDisplay');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const messageBox = document.getElementById('messageBox');

        // === Utility Functions ===
        
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = 'p-4 rounded-xl text-sm font-medium';
            if (isError) {
                messageBox.classList.add('bg-red-900/50', 'text-red-300', 'border', 'border-red-500');
            } else {
                messageBox.classList.add('bg-green-900/50', 'text-green-300', 'border', 'border-green-500');
            }
            messageBox.classList.remove('hidden');
        }

        function clearMessage() {
            messageBox.classList.add('hidden');
        }

        function setLoading(isLoading) {
            generateButton.disabled = isLoading;
            loadingOverlay.classList.toggle('hidden', !isLoading);
            loadingOverlay.classList.toggle('flex', isLoading);
        }

        // === Main Logic ===

        async function generateMockup() {
            clearMessage();
            const prompt = promptInput.value.trim();

            if (!prompt) {
                showMessage("Please provide a prompt describing your jersey design.", true);
                return;
            }

            setLoading(true);
            imageDisplay.innerHTML = '';
            
            // Craft the complete prompt to ensure it generates a "jersey mockup"
            const fullPrompt = `Photorealistic image of a sports jersey mockup. On a white background. ${prompt}.`;

            const payload = {
                instances: {
                    prompt: fullPrompt
                },
                parameters: {
                    sampleCount: 1,
                    // Optionally specify aspect ratio, e.g., "1:1" for square
                    aspectRatio: "1:1", 
                }
            };
            
            const apiUrl = `${API_ENDPOINT}${API_KEY}`;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    showMessage(`Attempt ${i + 1}/${MAX_RETRIES}: Sending prompt to Imagen...`, false);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const result = await response.json();

                    // Check if the response contains predictions
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const base64Data = result.predictions[0].bytesBase64Encoded;
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        
                        imageDisplay.innerHTML = `<img src="${imageUrl}" alt="Generated Jersey Mockup" class="mockup-image rounded-xl shadow-2xl">`;
                        showMessage("Success! Your custom jersey mockup is ready.", false);
                        setLoading(false);
                        return; // Exit function on success
                    } else {
                        throw new Error("API response was successful but contained no image data.");
                    }

                } catch (error) {
                    console.error(`Generation attempt ${i + 1} failed:`, error);
                    const errorMessage = error.message.includes('HTTP error') 
                        ? "API Error: Failed to communicate with the image generation server."
                        : `Generation Error: ${error.message}`;

                    if (i < MAX_RETRIES - 1) {
                        showMessage(`${errorMessage} Retrying in ${RETRY_DELAY_MS / 1000}s...`, true);
                        await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                    } else {
                        showMessage(`Final attempt failed: ${errorMessage}. Please check your prompt and try again.`, true);
                        setLoading(false);
                    }
                }
            }
        }
    </script>
</body>
</html>