<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Custom Jersey Designer</title>
    <!-- Load Tailwind CSS via CDN for guaranteed styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the app */
        html { font-family: 'Inter', sans-serif; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #8b5cf6; /* purple-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-900 text-white flex flex-col items-center p-4 sm:p-8">

    <header class="text-center mb-10 w-full max-w-4xl">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 mb-2">
            AI Custom Jersey Designer
        </h1>
        <p class="text-gray-400">Uses a Google Apps Script proxy for reliable generation.</p>
        <p class="text-sm text-yellow-400 mt-2">
            ⚠️ You must deploy the provided <code>Code.gs</code> script and replace the <code>APPS_SCRIPT_URL</code> below.
        </p>
    </header>

    <div class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- === Input Panel === -->
        <div class="lg:col-span-1 space-y-6 p-6 bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
            <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3">Design Instructions</h2>
            
            <div class="space-y-2">
                <label for="prompt" class="block text-gray-300 font-medium">1. Describe Your Jersey</label>
                <textarea
                    id="prompt"
                    class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-purple-500 focus:border-purple-500 transition duration-150 shadow-inner"
                    rows="5"
                    placeholder="E.g., 'A vintage 90s basketball jersey with neon green lightning bolts and a lion head logo in the center. Use a football jersey template.'"
                ></textarea>
            </div>

            <div class="space-y-2">
                <label class="block text-gray-300 font-medium">2. Upload Logo (Optional)</label>
                <input
                    type="file"
                    id="fileInput"
                    accept="image/png, image/jpeg"
                    class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-500/20 file:text-purple-300 hover:file:bg-purple-500/30 cursor-pointer"
                />
                <p id="fileStatus" class="text-xs text-green-400 hidden"></p>
            </div>

            <div id="errorBox" class="p-3 bg-red-700/50 border border-red-500 rounded-lg text-sm text-red-200 hidden"></div>

            <button
                id="generateButton"
                class="w-full mt-4 flex items-center justify-center px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg shadow-lg shadow-purple-900/50 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.01]"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zap h-5 w-5 mr-2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                <span id="buttonText">Generate Mockup</span>
            </button>
        </div>

        <!-- === Output Panel === -->
        <div class="lg:col-span-2 flex flex-col items-center p-6 bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
            <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3 w-full mb-4">Generated Result</h2>
            
            <div 
                id="imageContainer"
                class="relative w-full max-w-xl aspect-square flex items-center justify-center bg-gray-700 rounded-lg overflow-hidden border-4 border-dashed border-gray-600/50 transition-all duration-300"
                style="height: auto; max-height: 512px;"
            >
                <div id="loadingOverlay" class="absolute inset-0 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm z-10 hidden">
                    <div class="text-center">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-lg font-medium text-purple-300">Working on your design...</p>
                    </div>
                </div>
                <img id="resultImage" src="" alt="Generated Jersey Design" class="w-full h-full object-contain hidden transition-opacity duration-500">
                <div id="placeholder" class="text-center text-gray-500 p-8">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zap h-10 w-10 mx-auto mb-2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                    <p>Enter your prompt and click 'Generate Mockup' to see your custom jersey design.</p>
                </div>
            </div>

            <button
                id="downloadButton"
                disabled
                class="mt-6 flex items-center px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition duration-300 disabled:opacity-50 shadow-md shadow-green-900/50"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download h-5 w-5 mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                Download Design
            </button>
        </div>
    </div>

    <script>
        // === Core Application Logic ===
        
        // !!! IMPORTANT: Replace this URL with the one you get after deploying Code.gs !!!
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby83_HZcBuEr8Js1E5Qi26OpGvxKuD7jzjaEP4_XNu-kewnGWv7m9boeRraU4ybSWDq/exec';
        const MAX_RETRIES = 3;
        const RETRY_DELAY_MS = 1000; 

        // --- DOM Elements ---
        const promptInput = document.getElementById('prompt');
        const fileInput = document.getElementById('fileInput');
        const fileStatus = document.getElementById('fileStatus');
        const generateButton = document.getElementById('generateButton');
        const buttonText = document.getElementById('buttonText');
        const errorBox = document.getElementById('errorBox');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const resultImage = document.getElementById('resultImage');
        const placeholder = document.getElementById('placeholder');
        const downloadButton = document.getElementById('downloadButton');

        let selectedFile = null;
        let currentImageUrl = null;

        // --- Utility Functions ---

        /**
         * Retries a fetch request using exponential backoff.
         */
        const fetchWithRetry = async (url, options, retries = 0) => {
            try {
                const response = await fetch(url, options);
                if (!response.ok && retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * RETRY_DELAY_MS;
                    console.warn(`Fetch failed (${response.status}), retrying in ${delay}ms...`); 
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP error! Status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries < MAX_RETRIES && error.message.includes("Failed to fetch")) {
                    const delay = Math.pow(2, retries) * RETRY_DELAY_MS;
                    console.warn(`Network error, retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                throw error;
            }
        };

        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve({
                        mimeType: file.type,
                        data: base64String
                    });
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        const showError = (message) => {
            errorBox.textContent = `Generation Error: ${message}`;
            errorBox.classList.remove('hidden');
        };

        const clearError = () => {
            errorBox.classList.add('hidden');
        };

        const setLoadingState = (isLoading) => {
            generateButton.disabled = isLoading;
            loadingOverlay.classList.toggle('hidden', !isLoading);
            buttonText.textContent = isLoading ? 'Generating Design...' : 'Generate Mockup';
            generateButton.classList.toggle('bg-purple-600', !isLoading);
            generateButton.classList.toggle('bg-gray-600', isLoading);
        };

        // --- Event Handlers ---

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            clearError();

            if (file) {
                if (file.size > 1024 * 1024 * 4) { // 4MB limit
                    showError('File size exceeds 4MB limit. Please choose a smaller image.');
                    selectedFile = null;
                    fileStatus.classList.add('hidden');
                    return;
                }
                selectedFile = file;
                fileStatus.textContent = `${file.name} ready to be used as a logo.`;
                fileStatus.classList.remove('hidden');
            } else {
                selectedFile = null;
                fileStatus.classList.add('hidden');
            }
        });

        generateButton.addEventListener('click', async () => {
            const prompt = promptInput.value.trim();
            if (APPS_SCRIPT_URL === 'YOUR_DEPLOYED_APPS_SCRIPT_URL_HERE') {
                showError("Please deploy the Code.gs script first and update the APPS_SCRIPT_URL in the JavaScript.");
                return;
            }
            if (!prompt) {
                showError('Please provide a description for the jersey.');
                return;
            }
            
            clearError();
            setLoadingState(true);
            currentImageUrl = null;
            downloadButton.disabled = true;
            resultImage.classList.add('hidden');
            placeholder.classList.add('hidden');
            
            try {
                const logoData = selectedFile ? await fileToBase64(selectedFile) : null;
                
                const payload = { 
                    prompt, 
                    logoData 
                };

                const response = await fetchWithRetry(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }
                
                const base64Data = result.base64Data;
                
                if (!base64Data) {
                    throw new Error("Proxy failed to return image data. Check your Apps Script logs.");
                }

                const finalImageUrl = `data:image/png;base64,${base64Data}`;

                currentImageUrl = finalImageUrl;
                resultImage.src = finalImageUrl;
                resultImage.classList.remove('hidden');
                downloadButton.disabled = false;

            } catch (err) {
                console.error("Image generation failed:", err);
                showError(`Failed: ${err.message || 'An unknown error occurred.'}`);
                placeholder.classList.remove('hidden');
            } finally {
                setLoadingState(false);
            }
        });

        downloadButton.addEventListener('click', () => {
            if (currentImageUrl) {
                const link = document.createElement('a');
                link.href = currentImageUrl;
                link.download = 'jersey-design.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        // Initialize display state
        window.onload = () => {
            placeholder.classList.remove('hidden');
        };

    </script>
</body>
</html>